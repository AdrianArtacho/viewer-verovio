<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Harmony Viewer â€“ Verovio + MIDI</title>

<script src="https://www.verovio.org/javascript/latest/verovio-toolkit.js"></script>

<style>
  body {
    font-family: system-ui, sans-serif;
    margin: 20px;
  }

  #score svg {
    width: 100%;
  }

  .active {
    fill: darkred !important;
    stroke: darkred !important;
  }

  .controls {
    margin-bottom: 1em;
  }
</style>
</head>

<body>

<h2>Harmony Viewer (Verovio + MIDI)</h2>

<div class="controls">
  <button onclick="advanceChord()">Next chord</button>
  <span id="status"></span>
</div>

<div id="score"></div>

<script>
/* ------------------------------
   URL PARAMETER
-------------------------------- */
function getScoreFromURL() {
  const params = new URLSearchParams(window.location.search);
  return params.get("score") || "demo2.musicxml";
}

const scorePath = getScoreFromURL();
console.log("Loading score:", scorePath);
document.getElementById("status").textContent =
  "Score: " + scorePath;

/* ------------------------------
   VEROVIO SETUP
-------------------------------- */
const vrvToolkit = new verovio.toolkit();
let chordGroups = [];
let currentChord = 0;

/* ------------------------------
   LOAD SCORE
-------------------------------- */
fetch(scorePath)
  .then(r => {
    console.log("Fetching:", r.url);
    return r.text();
  })
  .then(xml => {
    vrvToolkit.setOptions({
      scale: 40,
      pageHeight: 1000,
      pageWidth: 2000
    });

    document.getElementById("score").innerHTML =
      vrvToolkit.renderData(xml, {});

    buildChordGroups();
    highlightCurrentChord();
  })
  .catch(err => {
    console.error("Failed to load score:", err);
    document.getElementById("status").textContent =
      "Error loading score.";
  });

/* ------------------------------
   GROUP NOTES INTO CHORDS
-------------------------------- */
function buildChordGroups() {
  chordGroups = [];

  const layers = Array.from(
    document.querySelectorAll(".layer")
  );

  layers.forEach(layer => {
    const elements = Array.from(layer.children);

    elements.forEach(el => {

      // --- CHORD ---
      if (el.classList.contains("chord")) {
        const noteheads = Array.from(
          el.querySelectorAll(".notehead")
        );
        if (noteheads.length > 0) {
          chordGroups.push(noteheads);
        }
      }

      // --- STANDALONE NOTE ---
      else if (el.classList.contains("note")) {
        const notehead = el.querySelector(".notehead");
        if (notehead) {
          chordGroups.push([notehead]);
        }
      }

      // --- BEAM (multiple notes) ---
      else if (el.classList.contains("beam")) {
        const notes = Array.from(
          el.querySelectorAll(".note")
        );

        notes.forEach(note => {
          const notehead = note.querySelector(".notehead");
          if (notehead) {
            chordGroups.push([notehead]);
          }
        });
      }

      // --- REST (optional: ignore for now) ---
      // else if (el.classList.contains("rest")) { }
    });
  });

  console.log("Total musical steps:", chordGroups.length);
}



/* ------------------------------
   HIGHLIGHTING
-------------------------------- */
function highlightCurrentChord() {
  document
    .querySelectorAll(".notehead")
    .forEach(n => n.classList.remove("active"));

  if (!chordGroups[currentChord]) return;

  chordGroups[currentChord].forEach(n =>
    n.classList.add("active")
  );
}




/* ------------------------------
   ADVANCE LOGIC
-------------------------------- */
function advanceChord() {
  if (currentChord < chordGroups.length - 1) {
    currentChord++;
    highlightCurrentChord();
  }
}

/* ------------------------------
   MIDI INPUT
-------------------------------- */
if (navigator.requestMIDIAccess) {
  navigator.requestMIDIAccess().then(midi => {
    console.log("MIDI access granted");

    for (let input of midi.inputs.values()) {
      console.log("MIDI input:", input.name);

      input.onmidimessage = msg => {
        console.log("MIDI message:", msg.data);

        const [status, note, velocity] = msg.data;
        if (status === 144 && velocity > 0) {
          advanceChord();
        }
      };
    }
  }).catch(err => {
    console.error("MIDI access failed:", err);
  });
} else {
  console.error("Web MIDI not supported");
}
</script>

</body>
</html>
